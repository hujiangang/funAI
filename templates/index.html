{% extends "base.html" %}

{% block title %}
    ä¸»é¡µ
{% endblock %}

{% block content %}
<!-- åˆ†ç±»äºŒçº§é¡µç­¾ - å›ºå®šåœ¨é¡¶éƒ¨ -->
    <div class="fixed top-[3.8rem] left-[7rem] right-[2rem] z-50 bg-gray-900 pt-0 pb-0 shadow-lg border-b border-gray-700">
        <div class="flex space-x-1 overflow-x-auto">
            <!-- æ¸¸æˆåˆ†ç±»ï¼ˆåŸå…¨éƒ¨ï¼‰ -->
            <a href="/" class="px-4 py-2 whitespace-nowrap transition-all duration-300 border-b-2 {% if not selected_category %}border-purple-500 text-purple-400{% else %}border-transparent text-gray-400 hover:text-gray-300{% endif %}">
                ğŸ® æ¸¸æˆ
            </a>
            <!-- åˆ†ç±»åˆ—è¡¨ - æ’é™¤é»˜è®¤çš„"æ¸¸æˆ"åˆ†ç±» -->
            {% for category in categories %}
            {% if category.name != "æ¸¸æˆ" %}
            <a href="/?category_id={{ category.id }}" class="px-4 py-2 whitespace-nowrap transition-all duration-300 border-b-2 {% if selected_category == category.id %}border-purple-500 text-purple-400{% else %}border-transparent text-gray-400 hover:text-gray-300{% endif %}">
                {{ category.name }}
            </a>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- æ¸¸æˆåˆ—è¡¨ - å¢åŠ é¡¶éƒ¨é—´è·ï¼Œé¿å…è¢«åˆ†ç±»æ é®æŒ¡ -->
    <div id="games-container" 
         class="pt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
         data-total-pages="{{ total_pages }}"
         data-selected-category="{{ selected_category if selected_category is not none else '' }}">
        {% for game in games %}
        <a href="/play/{{ game.id }}" class="group bg-gray-800 rounded-xl overflow-hidden border border-gray-700 hover:border-purple-500 hover:shadow-2xl hover:shadow-purple-500/20 transition-all duration-300">
            <div class="h-40 bg-gradient-to-br from-indigo-900 to-gray-900 flex items-center justify-center text-5xl group-hover:scale-110 transition-transform">
                ğŸ®
            </div>
            <div class="p-5">
                <h3 class="text-xl font-bold mb-2 group-hover:text-purple-400 transition">{{ game.title }}</h3>
                <div class="flex items-center gap-4 text-xs text-gray-400 mb-3">
                    <span>ğŸ‘¤ {{ game.author }}</span>
                    <span class="bg-gray-700 px-1.5 py-0.5 rounded text-[10px]">ğŸ¤– {{ game.ai_model }}</span>
                    <span class="text-yellow-400">{% for i in range(game.rating | int) %}â­{% endfor %}</span>
                </div>
                <div class="flex justify-between items-center text-xs text-gray-500 border-t border-gray-700 pt-2">
                    <span class="line-clamp-1">
                        {{ game.description or 'æš‚æ— ç®€ä»‹' }}
                    </span>
                    <span class="bg-gray-700 text-white px-2 py-0.5 rounded">çƒ­åº¦: {{ game.views }}</span>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    
    <!-- åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨ -->
    <div id="load-more" class="col-span-full text-center py-8 text-gray-500">
        <div class="flex items-center justify-center gap-2">
            <div class="w-5 h-5 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
            <span>åŠ è½½ä¸­...</span>
        </div>
    </div>
    
    <!-- æ²¡æœ‰æ›´å¤šæ¸¸æˆçš„æç¤º -->
    <div id="no-more" class="col-span-full text-center py-8 text-gray-500 hidden">
        <p>æ²¡æœ‰æ›´å¤šæ¸¸æˆäº†</p>
    </div>
    
    {% if not games %}
    <div class="col-span-full text-center py-12 text-gray-500">
        <p class="text-xl">æš‚æ— æ¸¸æˆ</p>
        <p class="text-sm mt-2">ç‚¹å‡»å³ä¸Šè§’çš„"ä¸Šä¼ æ–°æ¸¸æˆ"æ¥æ·»åŠ ç¬¬ä¸€ä¸ªæ¸¸æˆå§ï¼</p>
    </div>
    {% endif %}
</div>

<!-- ä¸‹æ‹‰åˆ·æ–°å’Œæ— é™æ»šåŠ¨åŠŸèƒ½ -->
<script>
    // ä»dataå±æ€§ä¸­è·å–åˆå§‹å€¼ï¼Œé¿å…ç›´æ¥ä½¿ç”¨æ¨¡æ¿å˜é‡å¯¼è‡´çš„IDEæŠ¥çº¢
    const gamesContainer = document.getElementById('games-container');
    const totalPages = parseInt(gamesContainer.dataset.totalPages) || 1;
    const selectedCategoryStr = gamesContainer.dataset.selectedCategory;
    const selectedCategory = selectedCategoryStr ? parseInt(selectedCategoryStr) : null;
    
    // å…¨å±€å˜é‡
    let currentPage = 2;
    let isLoading = false;
    let hasMore = currentPage <= totalPages;
    
    // åˆå§‹åŒ–ï¼šå¦‚æœæ²¡æœ‰æ›´å¤šæ¸¸æˆï¼Œéšè—åŠ è½½æŒ‡ç¤ºå™¨
    if (!hasMore) {
        document.getElementById('load-more').classList.add('hidden');
        document.getElementById('no-more').classList.remove('hidden');
    }
    
    // ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½
    let startY = 0;
    let isRefreshing = false;
    
    document.addEventListener('touchstart', (e) => {
        if (window.scrollY === 0) {
            startY = e.touches[0].clientY;
        }
    });
    
    document.addEventListener('touchmove', (e) => {
        if (window.scrollY === 0 && e.touches[0].clientY > startY + 50 && !isRefreshing) {
            isRefreshing = true;
            window.location.reload();
        }
    });
    
    // åŠ è½½æ›´å¤šæ¸¸æˆçš„å‡½æ•°
    async function loadMoreGames() {
        if (isLoading || !hasMore) return;
        
        isLoading = true;
        
        try {
            // æ„å»ºè¯·æ±‚URL
            let url = `/api/games?page=${currentPage}`;
            if (selectedCategory) {
                url += `&category_id=${selectedCategory}`;
            }
            
            // å‘é€è¯·æ±‚
            const response = await fetch(url);
            const data = await response.json();
            
            // æ›´æ–°çŠ¶æ€
            currentPage = data.current_page + 1;
            hasMore = currentPage <= data.total_pages;
            
            // æ¸²æŸ“æ–°æ¸¸æˆ
            const gamesContainer = document.getElementById('games-container');
            data.games.forEach(game => {
                const gameElement = document.createElement('a');
                gameElement.href = `/play/${game.id}`;
                gameElement.className = 'group bg-gray-800 rounded-xl overflow-hidden border border-gray-700 hover:border-purple-500 hover:shadow-2xl hover:shadow-purple-500/20 transition-all duration-300';
                
                // ç”Ÿæˆæ˜Ÿçº§è¯„åˆ†
                const stars = 'â­'.repeat(Math.floor(game.rating));
                
                gameElement.innerHTML = `
                    <div class="h-40 bg-gradient-to-br from-indigo-900 to-gray-900 flex items-center justify-center text-5xl group-hover:scale-110 transition-transform">
                        ğŸ®
                    </div>
                    <div class="p-5">
                        <h3 class="text-xl font-bold mb-2 group-hover:text-purple-400 transition">${game.title}</h3>
                        <div class="flex items-center gap-4 text-xs text-gray-400 mb-3">
                            <span>ğŸ‘¤ ${game.author}</span>
                            <span class="bg-gray-700 px-1.5 py-0.5 rounded text-[10px]">ğŸ¤– ${game.ai_model}</span>
                            <span class="text-yellow-400">${stars}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs text-gray-500 border-t border-gray-700 pt-2">
                            <span class="line-clamp-1">
                                ${game.description || 'æš‚æ— ç®€ä»‹'}
                            </span>
                            <span class="bg-gray-700 text-white px-2 py-0.5 rounded">çƒ­åº¦: ${game.views}</span>
                        </div>
                    </div>
                `;
                
                gamesContainer.appendChild(gameElement);
            });
            
            // æ›´æ–°åŠ è½½çŠ¶æ€
            if (!hasMore) {
                document.getElementById('load-more').classList.add('hidden');
                document.getElementById('no-more').classList.remove('hidden');
            }
        } catch (error) {
            console.error('åŠ è½½æ¸¸æˆå¤±è´¥:', error);
        } finally {
            isLoading = false;
        }
    }
    
    // æ»šåŠ¨åˆ°åº•éƒ¨è‡ªåŠ¨åŠ è½½æ›´å¤š
    window.addEventListener('scroll', () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
            loadMoreGames();
        }
    });
    
    // ç›‘å¬åˆ†ç±»åˆ‡æ¢ï¼Œé‡ç½®æ‡’åŠ è½½çŠ¶æ€
    document.querySelectorAll('.space-x-1 a').forEach(link => {
        link.addEventListener('click', (e) => {
            // ä¿å­˜å½“å‰åˆ†ç±»ï¼Œç”¨äºåç»­è¯·æ±‚
            const href = e.currentTarget.href;
            const url = new URL(href);
            const categoryParam = url.searchParams.get('category_id');
            selectedCategory = categoryParam ? parseInt(categoryParam) : null;
            
            // é‡ç½®çŠ¶æ€
            currentPage = 2;
            isLoading = false;
            hasMore = true;
        });
    });
</script>
{% endblock %}