<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰›é¡¿çš„æ€è€ƒï¼šä»è‹¹æœåˆ°æœˆäº®</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a2e;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        #container {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border-radius: 8px;
            overflow: hidden;
        }

        canvas {
            display: block;
            background: radial-gradient(circle, #2a2a4e 0%, #0f0f1a 100%);
        }

        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°ä¸‹é¢çš„æŒ‰é’® */
        }

        h1 {
            margin: 0;
            font-size: 24px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            color: #fff;
        }

        #story-text {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            max-width: 400px;
            line-height: 1.6;
            font-size: 16px;
            transition: all 0.5s ease;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        button {
            padding: 10px 25px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            background: #ffcc00;
            color: #333;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.1s, background 0.2s;
        }

        button:hover {
            transform: scale(1.05);
            background: #ffe066;
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            transform: none;
        }

        .highlight {
            color: #ffcc00;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="container">
        <canvas id="simCanvas" width="800" height="600"></canvas>
        
        <div id="ui-layer">
            <h1>ç‰›é¡¿çš„æ€è€ƒï¼šå¼•åŠ›çš„è§‰é†’</h1>
            <div id="story-text">
                ç‚¹å‡»â€œä¸‹ä¸€æ­¥â€å¼€å§‹æ¼”ç¤ºç‰›é¡¿çš„æ€è€ƒè¿‡ç¨‹ã€‚
            </div>
        </div>

        <div id="controls">
            <button id="btn-action" onclick="nextPhase()">å¼€å§‹æ¼”ç¤º</button>
            <button id="btn-reset" onclick="resetSim()" style="background-color: #ff6b6b; color: white; display:none;">é‡ç½®</button>
        </div>
    </div>

<script>
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    const storyBox = document.getElementById('story-text');
    const actionBtn = document.getElementById('btn-action');
    const resetBtn = document.getElementById('btn-reset');

    // çŠ¶æ€ç®¡ç†
    let phase = 0; // 0:Intro, 1:Apple Fall, 2:Cannon Setup, 3:Shot 1, 4:Shot 2, 5:Orbit
    let animationId;
    
    // ç‰©ç†å‚æ•°
    const EARTH_RADIUS = 120;
    const EARTH_CENTER = { x: 400, y: 300 + EARTH_RADIUS + 150 }; // åœ°çƒåœ¨åº•éƒ¨ (ç¬¬ä¸€å¹•)
    const EARTH_CENTER_SPACE = { x: 400, y: 300 }; // åœ°çƒåœ¨ä¸­é—´ (ç¬¬äºŒå¹•)
    
    // ç‰©ä½“çŠ¶æ€
    let apple = { x: 0, y: 0, vy: 0, active: false, type: 'apple' };
    let projectile = { x: 0, y: 0, vx: 0, vy: 0, path: [], active: false, crash: false };
    
    // è§†è§‰ç¼©æ”¾
    let currentScale = 1;
    let targetScale = 1;
    let currentCenter = { ...EARTH_CENTER };
    let targetCenter = { ...EARTH_CENTER };

    // åˆå§‹åŒ–ç»˜åˆ¶å¾ªç¯
    function loop() {
        update();
        draw();
        animationId = requestAnimationFrame(loop);
    }

    function update() {
        // åœºæ™¯å¹³æ»‘è¿‡æ¸¡ (æ‘„åƒæœºç§»åŠ¨)
        currentCenter.x += (targetCenter.x - currentCenter.x) * 0.05;
        currentCenter.y += (targetCenter.y - currentCenter.y) * 0.05;

        // ç¬¬ä¸€å¹•ï¼šè‹¹æœä¸‹è½
        if (phase === 1 && apple.active) {
            apple.vy += 0.2; // é‡åŠ›
            apple.y += apple.vy;
            // æ’åœ°æ£€æµ‹
            if (apple.y > currentCenter.y - EARTH_RADIUS - 5) { // 5æ˜¯è‹¹æœåŠå¾„
                apple.y = currentCenter.y - EARTH_RADIUS - 5;
                apple.vy = -apple.vy * 0.3; // å¼¹è·³ä¸€ç‚¹ç‚¹
                if (Math.abs(apple.vy) < 0.5) {
                    apple.vy = 0;
                    apple.active = false; // åœæ­¢æ¨¡æ‹Ÿ
                    actionBtn.disabled = false;
                    actionBtn.innerText = "æ€è€ƒï¼šå¦‚æœæ›´é«˜ï¼Ÿ";
                }
            }
        }

        // ç¬¬äºŒå¹• & ç¬¬ä¸‰å¹•ï¼šç‰›é¡¿å¤§ç‚®
        if ((phase === 3 || phase === 4 || phase === 5) && projectile.active && !projectile.crash) {
            // ä¸‡æœ‰å¼•åŠ›æ¨¡æ‹Ÿ
            let dx = projectile.x - currentCenter.x;
            let dy = projectile.y - currentCenter.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            
            // å¼•åŠ›å…¬å¼ F = G*M/r^2 (ç®€åŒ–ç‰ˆ)
            // åŠ é€Ÿåº¦ a = F/m -> aæ­£æ¯”äº 1/dist^2
            const GM = 4000; // è™šæ‹Ÿå¼•åŠ›å¸¸æ•°
            let ax = -GM * dx / (dist * dist * dist);
            let ay = -GM * dy / (dist * dist * dist);

            projectile.vx += ax;
            projectile.vy += ay;
            projectile.x += projectile.vx;
            projectile.y += projectile.vy;

            // è®°å½•è½¨è¿¹
            if (frameCount % 3 === 0) {
                projectile.path.push({x: projectile.x, y: projectile.y});
                if (projectile.path.length > 200) projectile.path.shift(); // é™åˆ¶è½¨è¿¹é•¿åº¦
            }

            // æ’åœ°æ£€æµ‹
            if (dist < EARTH_RADIUS) {
                projectile.crash = true;
                projectile.active = false;
                if (phase !== 5) {
                    actionBtn.disabled = false;
                    actionBtn.innerText = phase === 3 ? "å†ç”¨åŠ›ä¸€ç‚¹ï¼" : "é€Ÿåº¦å†å¿«ä¸€ç‚¹ï¼";
                }
            }
        }
    }

    let frameCount = 0;
    function draw() {
        frameCount++;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶èƒŒæ™¯æ˜Ÿç©º
        drawStars();

        // ç»˜åˆ¶åœ°çƒ
        ctx.save();
        ctx.translate(currentCenter.x, currentCenter.y);
        
        // å¤§æ°”å±‚å…‰æ™•
        let grad = ctx.createRadialGradient(0, 0, EARTH_RADIUS, 0, 0, EARTH_RADIUS * 1.2);
        grad.addColorStop(0, "rgba(100, 149, 237, 0.3)");
        grad.addColorStop(1, "rgba(100, 149, 237, 0)");
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(0, 0, EARTH_RADIUS * 1.2, 0, Math.PI * 2);
        ctx.fill();

        // åœ°çƒæœ¬ä½“
        ctx.fillStyle = "#2e86de";
        ctx.beginPath();
        ctx.arc(0, 0, EARTH_RADIUS, 0, Math.PI * 2);
        ctx.fill();
        
        // ç®€å•çš„é™†åœ°çº¹ç†
        ctx.fillStyle = "#2ecc71";
        ctx.beginPath();
        ctx.arc(0, 0, EARTH_RADIUS * 0.8, 0.2, 1.2); // å‡è£…æ˜¯å¤§é™†
        ctx.fill();
        
        // ç»˜åˆ¶é«˜å±± (ä»…åœ¨é˜¶æ®µ2åŠä»¥åæ˜¾ç¤º)
        if (phase >= 2) {
            ctx.fillStyle = "#95a5a6";
            ctx.beginPath();
            ctx.moveTo(0, -EARTH_RADIUS);
            ctx.lineTo(15, -EARTH_RADIUS - 30); // å±±é«˜30
            ctx.lineTo(30, -EARTH_RADIUS);
            ctx.fill();
        } else {
            // ç¬¬ä¸€é˜¶æ®µç”»ä¸€æ£µç®€å•çš„æ ‘
            ctx.fillStyle = "#8e44ad"; // ç‰›é¡¿çš„æ ‘
            // æ ‘å¹²
            ctx.fillRect(-10, -EARTH_RADIUS - 40, 20, 40);
            // æ ‘å† 
            ctx.fillStyle = "#27ae60";
            ctx.beginPath();
            ctx.arc(0, -EARTH_RADIUS - 50, 30, 0, Math.PI * 2);
            ctx.fill();
        }

        ctx.restore();

        // ç»˜åˆ¶è‹¹æœ (é˜¶æ®µ1)
        if (phase === 1) {
            ctx.save();
            ctx.translate(currentCenter.x, currentCenter.y); // è·Ÿéšåœ°çƒåæ ‡ç³»
            ctx.fillStyle = "#e74c3c";
            ctx.beginPath();
            // è‹¹æœç›¸å¯¹åœ°çƒä¸­å¿ƒçš„ä½ç½®
            // åˆå§‹ä½ç½®è®¾å®šåœ¨æ ‘å† ä¸‹
            let drawX = apple.x; 
            // apple.y æ˜¯ç›¸å¯¹äºå±å¹•çš„ï¼Œè¿™é‡Œéœ€è¦è½¬æ¢ä¸€ä¸‹é€»è¾‘ï¼Œ
            // ç®€å•èµ·è§ï¼Œphase 1 æˆ‘ä»¬ç›´æ¥ç”¨å±å¹•åæ ‡ç”»
            ctx.restore();
            
            ctx.fillStyle = "#e74c3c";
            ctx.beginPath();
            ctx.arc(apple.x, apple.y, 6, 0, Math.PI * 2);
            ctx.fill();
            // è‹¹æœè’‚
            ctx.strokeStyle = "#5d4037";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(apple.x, apple.y - 6);
            ctx.lineTo(apple.x + 2, apple.y - 10);
            ctx.stroke();
        }

        // ç»˜åˆ¶ç‚®å¼¹/æœˆçƒ (é˜¶æ®µ3+)
        if (phase >= 3) {
            // ç»˜åˆ¶è½¨è¿¹
            if (projectile.path.length > 0) {
                ctx.strokeStyle = "rgba(255, 255, 0, 0.5)";
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(projectile.path[0].x, projectile.path[0].y);
                for (let p of projectile.path) {
                    ctx.lineTo(p.x, p.y);
                }
                ctx.stroke();
            }

            // ç»˜åˆ¶ç‰©ä½“
            if (!projectile.crash) {
                ctx.fillStyle = phase === 5 ? "#ecf0f1" : "#e74c3c"; // è½¨é“çŠ¶æ€å˜ç™½(æœˆçƒ)
                ctx.beginPath();
                ctx.arc(projectile.x, projectile.y, 5, 0, Math.PI * 2);
                ctx.fill();
                // å¦‚æœæ˜¯æœˆçƒï¼ŒåŠ ç‚¹å…‰æ™•
                if (phase === 5) {
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = "white";
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            } else {
                // æ’å‡»æ•ˆæœ
                ctx.fillStyle = "orange";
                ctx.font = "20px Arial";
                ctx.fillText("ğŸ’¥", projectile.x - 10, projectile.y + 5);
            }
        }
    }

    // ç®€å•çš„æ˜Ÿç©ºèƒŒæ™¯
    const stars = [];
    for(let i=0; i<100; i++) {
        stars.push({
            x: Math.random() * 800,
            y: Math.random() * 600,
            size: Math.random() * 2
        });
    }
    function drawStars() {
        ctx.fillStyle = "white";
        for(let s of stars) {
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
            ctx.fill();
        }
    }

    // æµç¨‹æ§åˆ¶å™¨
    function nextPhase() {
        actionBtn.disabled = true;

        if (phase === 0) {
            // å¼€å§‹ï¼šè‹¹æœåœºæ™¯
            phase = 1;
            storyBox.innerHTML = "1666å¹´ï¼Œä¼å°”ç´¢æ™®åº„å›­ã€‚<br>ç‰›é¡¿ååœ¨æ ‘ä¸‹ï¼Œçœ‹åˆ°ä¸€é¢—<span class='highlight'>è‹¹æœ</span>å‚ç›´è½ä¸‹ã€‚<br>ä»–æ€è€ƒï¼šä¸ºä»€ä¹ˆå®ƒæ€»æ˜¯è½å‘åœ°å¿ƒï¼Ÿ";
            
            // è®¾ç½®è‹¹æœåˆå§‹ä½ç½® (å±å¹•åæ ‡)
            apple.x = 400 + 10; 
            apple.y = currentCenter.y - EARTH_RADIUS - 60; // æ ‘ä¸Š
            apple.active = true;
            apple.vy = 0;
            
        } else if (phase === 1) {
            // åˆ‡æ¢åˆ°å¤ªç©ºè§†è§’ (æ€ç»´å®éªŒ)
            phase = 2;
            storyBox.innerHTML = "ç‰›é¡¿å±•å¼€äº†æƒ³è±¡ï¼š<br>å¦‚æœæˆ‘åœ¨æé«˜çš„å±±é¡¶æ¶è®¾ä¸€é—¨å¤§ç‚®ï¼Œ<br>åƒæ‰”è‹¹æœä¸€æ ·æŠŠç‚®å¼¹æ°´å¹³å°„å‡ºï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ";
            actionBtn.innerText = "å‘å°„ç¬¬ä¸€æšç‚®å¼¹";
            actionBtn.disabled = false;
            
            // ç§»åŠ¨ç›¸æœº
            targetCenter = EARTH_CENTER_SPACE;

        } else if (phase === 2) {
            // å‘å°„ 1 (å è½)
            phase = 3;
            storyBox.innerHTML = "<b>é€Ÿåº¦è¾ƒæ…¢æ—¶ï¼š</b><br>ç‚®å¼¹å—å¼•åŠ›æ‹‰æ‰¯ï¼Œç”»å‡ºä¸€æ¡æŠ›ç‰©çº¿ï¼Œæœ€åè½å›åœ°é¢ã€‚<br>è¿™å’Œè‹¹æœè½åœ°æœ¬è´¨æ˜¯ä¸€æ ·çš„ã€‚";
            fireCannon(2); // ä½é€Ÿ

        } else if (phase === 3) {
            // å‘å°„ 2 (æ›´è¿œ)
            phase = 4;
            storyBox.innerHTML = "<b>é€Ÿåº¦å¢åŠ åï¼š</b><br>ç‚®å¼¹é£å¾—æ›´è¿œäº†ã€‚<br>è™½ç„¶å¼•åŠ›åœ¨æŠŠå®ƒå¾€ä¸‹æ‹‰ï¼Œä½†å®ƒå‰è¿›äº†å¾ˆè¿œæ‰è½åœ°ã€‚";
            fireCannon(3.5); // ä¸­é€Ÿ

        } else if (phase === 4) {
            // å‘å°„ 3 (è½¨é“)
            phase = 5;
            storyBox.innerHTML = "<b>é€Ÿåº¦è¶³å¤Ÿå¿«æ—¶ (ç¬¬ä¸€å®‡å®™é€Ÿåº¦)ï¼š</b><br>ç¥å¥‡çš„äº‹æƒ…å‘ç”Ÿäº†ï¼<br>å®ƒä¸‹è½çš„å¼§åº¦æ­£å¥½ç­‰äºåœ°çƒè¡¨é¢çš„æ›²ç‡ã€‚<br><b>å®ƒä¾ç„¶åœ¨â€œæ‰è½â€ï¼Œä½†æ°¸è¿œæ‰ä¸åˆ°åœ°ä¸Šã€‚è¿™å°±æ˜¯æœˆçƒç»•åœ°çš„åŸç†ã€‚</b>";
            fireCannon(5.3); // è½¨é“é€Ÿåº¦
            actionBtn.style.display = 'none';
            resetBtn.style.display = 'block';
        }
    }

    function fireCannon(vx) {
        projectile.active = true;
        projectile.crash = false;
        projectile.path = [];
        // å‘å°„ç‚¹ï¼šåœ°çƒä¸­å¿ƒ + åŠå¾„ + å±±é«˜ (å±å¹•åæ ‡)
        projectile.x = currentCenter.x + 15; // å±±é¡¶x
        projectile.y = currentCenter.y - EARTH_RADIUS - 30; // å±±é¡¶y
        projectile.vx = vx;
        projectile.vy = 0;
    }

    function resetSim() {
        phase = 0;
        targetCenter = { ...EARTH_CENTER };
        currentCenter = { ...EARTH_CENTER }; // ç«‹å³å¤ä½é¿å…åŠ¨ç”»å»¶è¿Ÿé—®é¢˜
        apple.active = false;
        projectile.active = false;
        projectile.path = [];
        
        storyBox.innerHTML = "ç‚¹å‡»â€œå¼€å§‹æ¼”ç¤ºâ€é‡ç°ç‰›é¡¿çš„é¡¿æ‚Ÿæ—¶åˆ»ã€‚";
        actionBtn.style.display = 'block';
        actionBtn.innerText = "å¼€å§‹æ¼”ç¤º";
        actionBtn.disabled = false;
        resetBtn.style.display = 'none';
    }

    // å¯åŠ¨å¾ªç¯
    loop();

</script>
</body>
</html>